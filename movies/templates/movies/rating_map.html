{% extends 'base.html' %}

{% block title %}Movie Popularity Map{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="text-center">Movie Popularity Map</h1>
    <p class="text-center">Each marker shows the most purchased movie in that city (by quantity).</p>

    <!-- Map container -->
    <div id="map" style="height: 600px; width: 100%;"></div>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        // Initialize map centered on Atlanta
        var map = L.map('map').setView([33.7490, -84.3880], 6);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Parse Django JSON safely
        var movieCounts = JSON.parse('{{ movie_counts_json|escapejs }}');

        // Create a LayerGroup for markers
        var markerGroup = L.layerGroup().addTo(map);

        // Add a marker per city
        movieCounts.forEach(function(mc) {
            if(mc.latitude && mc.longitude) {
                L.marker([mc.latitude, mc.longitude])
                 .bindPopup(mc.movie_name + ' (' + mc.total_quantity + ' units purchased in ' + mc.city + ')')
                 .addTo(markerGroup);
            }
        });
    });
    </script>
</div>
{% endblock %}
